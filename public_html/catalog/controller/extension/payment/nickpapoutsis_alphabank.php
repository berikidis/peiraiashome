<?php class ControllerExtensionPaymentNickpapoutsisAlphabank extends Controller{public function index(){$this->load->language('extension/payment/nickpapoutsis_alphabank');$this->load->model('extension/payment/nickpapoutsis_alphabank');$this->load->model('checkout/order');$data['button_confirm']=$this->language->get('button_confirm');$data['text_title']=$this->language->get('text_title');$data['num_of_installments']=$this->language->get('num_of_installments');$data['zero_installments']=$this->language->get('zero_installments');$data['installments']=$this->language->get('installments');$data['card_chosen']=$this->language->get('card_chosen');$data['masterpass_header']=$this->language->get('masterpass_header');$data['masterpass_chosen']=$this->language->get('masterpass_chosen');$data['pay_method_name']=$this->language->get('pay_method_name');$data['error_failed']=$this->language->get('error_failed');$data['error_refused']=$this->language->get('error_refused');$data['error_canceled']=$this->language->get('error_canceled');$order_data=$this->model_checkout_order->getOrder($this->session->data['order_id']);if($this->config->get('nickpapoutsis_alphabank_debug')==1){$this->model_payment_nickpapoutsis_alphabank->logger($order_data);}$char_arr=['&amp;','\'','"',';','<','>','&'];$order_data['payment_address_1']=str_replace($char_arr,"",$order_data['payment_address_1']);$order_data['payment_city']=str_replace($char_arr,"",$order_data['payment_city']);$order_data['shipping_address_1']=str_replace($char_arr,"",$order_data['shipping_address_1']);if($this->config->get('nickpapoutsis_alphabank_environment')==1){if(!empty($this->config->get('nickpapoutsis_alphabank_live_url'))){$data['action']=$this->config->get('nickpapoutsis_alphabank_live_url');}else{$data['action']='https://www.alphaecommerce.gr/vpos/shophandlermpi';}}else{if(!empty($this->config->get('nickpapoutsis_alphabank_test_url'))){$data['action']=$this->config->get('nickpapoutsis_alphabank_test_url');}else{$data['action']='https://alphaecommerce-test.cardlink.gr/vpos/shophandlermpi';}}$data["version"]=2;$data["mid"]=$this->config->get("nickpapoutsis_alphabank_merchant_id");$data["lang"]=($this->session->data['language']==='el-gr'||$this->session->data['language']==='gr')?'el':'en';$data["orderid"]=$order_data['order_id']."NP".time();if(isset($this->request->post["user_selected_installments"])||isset($this->request->post["card_masterpass_selection"])){$json__updated_values["orderid"]=$data["orderid"];}$data["orderDesc"]=mb_substr($this->config->get("nickpapoutsis_alphabank_order_description"),0,128,"UTF-8");$data["orderAmount"]=round($order_data['total'],2);$data["currency"]=$order_data['currency_code'];$data["payerEmail"]='';$data["payerPhone"]='';$data["billCountry"]=isset($order_data['payment_iso_code_2'])?$order_data['payment_iso_code_2']:'';if(isset($order_data['payment_iso_code_2'])&&$order_data['payment_iso_code_2']==="GR"){$data["billState"]='';}else{$data["billState"]=isset($order_data['payment_zone_code'])?substr($order_data['payment_zone_code'],0,50):'';}$data["billZip"]=isset($order_data['payment_postcode'])?substr($order_data['payment_postcode'],0,16):'';$data["billCity"]=isset($order_data['payment_city'])?substr($order_data['payment_city'],0,64):'';$data["billAddress"]=isset($order_data['payment_address_1'])?substr($order_data['payment_address_1'],0,100):'';$data["shipCountry"]='';$data["shipState"]='';$data["shipZip"]='';$data["shipCity"]='';$data["shipAddress"]='';$data['masterpass_status']=$this->config->get('nickpapoutsis_alphabank_masterpass_status');if(isset($this->request->post["card_masterpass_selection"])&&$this->request->post["card_masterpass_selection"]=='auto:MasterPass'){$data["payMethod"]='auto:MasterPass';$json__updated_values["payMethod"]=$data["payMethod"];}else{$data["payMethod"]='';$json__updated_values["payMethod"]=$data["payMethod"];}$data["trType"]=$this->config->get("nickpapoutsis_alphabank_settlement_type");if(isset($this->request->post["user_selected_installments"])&&$this->request->post["user_selected_installments"]>0){$data["extInstallmentoffset"]=0;$json__updated_values["extInstallmentoffset"]=$data["extInstallmentoffset"];$data["extInstallmentperiod"]=$this->request->post["user_selected_installments"];$json__updated_values["extInstallmentperiod"]=$data["extInstallmentperiod"];}else{$data["extInstallmentoffset"]='';$json__updated_values["extInstallmentoffset"]=$data["extInstallmentoffset"];$data["extInstallmentperiod"]='';$json__updated_values["extInstallmentperiod"]=$data["extInstallmentperiod"];}$data["extRecurringfrequency"]='';$data["extRecurringenddate"]='';$data["cssUrl"]=$this->config->get("nickpapoutsis_alphabank_css_url");$data["confirmUrl"]=$this->url->link('extension/payment/nickpapoutsis_alphabank/notify','',true);$data["cancelUrl"]=$this->url->link('extension/payment/nickpapoutsis_alphabank/notify','',true);$data["var1"]='';$data["var2"]='';$data["var3"]='';$data["var4"]='';$data["var5"]='';$digest_string=$data["version"].$data["mid"].$data["lang"].$data["orderid"].$data["orderDesc"].$data["orderAmount"].$data["currency"].$data["payerEmail"].$data["payerPhone"].$data["billCountry"].$data["billState"].$data["billZip"].$data["billCity"].$data["billAddress"].$data["shipCountry"].$data["shipState"].$data["shipZip"].$data["shipCity"].$data["shipAddress"].$data["payMethod"].$data["trType"].$data["extInstallmentoffset"].$data["extInstallmentperiod"].$data["extRecurringfrequency"].$data["extRecurringenddate"].$data["cssUrl"].$data["confirmUrl"].$data["cancelUrl"].$this->config->get("nickpapoutsis_alphabank_secret");$data["digest"]=base64_encode(hash('sha256',$digest_string,true));$installments_text=$this->config->get('nickpapoutsis_alphabank_installments');if(!empty($installments_text)){$inst_text_arr=explode(",",$installments_text);foreach($inst_text_arr as $key=>$value){$inst_pairs=explode(":",$value);if($data["orderAmount"]>$inst_pairs[0]){$data['valid_installments'][]=(int)$inst_pairs[1];}}}if(isset($this->request->post["user_selected_installments"])||isset($this->request->post["card_masterpass_selection"])){$json__updated_values["digest"]=$data["digest"];if($this->config->get('nickpapoutsis_alphabank_debug')==1){$this->model_payment_nickpapoutsis_alphabank->logger($json__updated_values);$this->model_payment_nickpapoutsis_alphabank->logger($data);}$this->response->addHeader('Content-Type: application/json');$this->response->setOutput(json_encode($json__updated_values));}else{if($this->config->get('nickpapoutsis_alphabank_debug')==1){$this->model_payment_nickpapoutsis_alphabank->logger($digest_string);$this->model_payment_nickpapoutsis_alphabank->logger($data);}$x=var_dump($this->config->get('config_template'));$this->log->write($x);$this->log->write($this->config->get('config_template'));if(file_exists(DIR_TEMPLATE.$this->config->get('config_template').'/template/extension/payment/nickpapoutsis_alphabank.tpl')){return $this->load->view($this->config->get('config_template').'/template/extension/payment/nickpapoutsis_alphabank.tpl',$data);}else{return $this->load->view('extension/payment/nickpapoutsis_alphabank.tpl',$data);}}}public function notify(){$this->language->load('extension/payment/nickpapoutsis_alphabank');$this->load->model('extension/payment/nickpapoutsis_alphabank');isset($_POST["version"])?($received_post__version=$_POST["version"]):($received_post__version="");isset($_POST["mid"])?($received_post__mid=$_POST["mid"]):($received_post__mid="");isset($_POST["orderid"])?($received_post__orderid=$_POST["orderid"]):($received_post__orderid="");isset($_POST["status"])?($received_post__status=$_POST["status"]):($received_post__status="");isset($_POST["orderAmount"])?($received_post__orderAmount=$_POST["orderAmount"]):($received_post__orderAmount="");isset($_POST["currency"])?($received_post__currency=$_POST["currency"]):($received_post__currency="");isset($_POST["paymentTotal"])?($received_post__paymentTotal=$_POST["paymentTotal"]):($received_post__paymentTotal="");isset($_POST["message"])?($received_post__message=$_POST["message"]):($received_post__message="");isset($_POST["riskScore"])?($received_post__riskScore=$_POST["riskScore"]):($received_post__riskScore="");isset($_POST["payMethod"])?($received_post__payMethod=$_POST["payMethod"]):($received_post__payMethod="");isset($_POST["txId"])?($received_post__txId=$_POST["txId"]):($received_post__txId="");isset($_POST["paymentRef"])?($received_post__paymentRef=$_POST["paymentRef"]):($received_post__paymentRef="");isset($_POST["digest"])?($received_post__digest=$_POST["digest"]):($received_post__digest="");$received_post__string=$received_post__version.$received_post__mid.$received_post__orderid.$received_post__status.$received_post__orderAmount.$received_post__currency.$received_post__paymentTotal.$received_post__message.$received_post__riskScore.$received_post__payMethod.$received_post__txId.$received_post__paymentRef.$this->config->get("nickpapoutsis_alphabank_secret");$received_post__string_digest=base64_encode(hash('sha256',$received_post__string,true));if($this->config->get('nickpapoutsis_alphabank_debug')==1){$this->model_payment_nickpapoutsis_alphabank->logger($_POST);$this->model_payment_nickpapoutsis_alphabank->logger($received_post__string);$this->model_payment_nickpapoutsis_alphabank->logger($received_post__string_digest);}if($received_post__string_digest==$received_post__digest){if((strtoupper($received_post__status)==="AUTHORIZED"||strtoupper($received_post__status)==="CAPTURED")){$received_post__orderid=explode("NP",$received_post__orderid)[0];$this->load->model("checkout/order");$order_comment='<table><tbody><tr><td>Order ID: </td><td>'.$received_post__orderid.'</td></tr><tr><td>Charge: </td><td>'.$received_post__orderAmount.'</td></tr><tr><td>Currency&nbsp;Code: </td><td>'.$received_post__currency.'</td></tr><tr><td>Status: </td><td>'.$received_post__status.'</td></tr><tr><td>Payment Method: &nbsp;&nbsp;</td><td>'.$received_post__payMethod.'</td></tr><tr><td>Payment&nbsp;Ref: </td><td>'.$received_post__paymentRef.'</td></tr><tr><td>Transaction ID: </td><td>'.$received_post__txId.'</td></tr><tr><td>Message: </td><td>'.$received_post__message.'</td></tr></tbody></table>';if(strtoupper($received_post__status)==="CAPTURED"){$this->model_checkout_order->addOrderHistory($received_post__orderid,$this->config->get("nickpapoutsis_alphabank_order_status_sale_id"),$order_comment,false,false);}elseif(strtoupper($received_post__status)==="AUTHORIZED"){$this->model_checkout_order->addOrderHistory($received_post__orderid,$this->config->get("nickpapoutsis_alphabank_order_status_preauth_id"),$order_comment,false,false);}if($this->config->get('nickpapoutsis_alphabank_debug')==1){$this->model_payment_nickpapoutsis_alphabank->logger($this->session->data);}$this->response->redirect($this->url->link('checkout/success','',true));}else{if($received_post__status=="CANCELED"||$received_post__status=="CANCELLED"){$this->session->data['error']=$this->language->get('error_canceled');}elseif($received_post__status=="REFUSED"){$this->session->data['error']=$this->language->get('error_refused');}else{$this->session->data['error']=$this->language->get('error_failed');}if($this->config->get('nickpapoutsis_alphabank_debug')==1){$this->model_payment_nickpapoutsis_alphabank->logger($received_post__status);$this->model_payment_nickpapoutsis_alphabank->logger($this->session->data);}$this->response->redirect($this->url->link('checkout/checkout','',true));}}}}
